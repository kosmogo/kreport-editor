<!DOCTYPE html>  <html> <head>   <title>main.coffee</title>   <meta http-equiv="content-type" content="text/html; charset=UTF-8">   <link rel="stylesheet" media="all" href="docco.css" /> </head> <body>   <div id="container">     <div id="background"></div>          <table cellpadding="0" cellspacing="0">       <thead>         <tr>           <th class="docs">             <h1>               main.coffee             </h1>           </th>           <th class="code">           </th>         </tr>       </thead>       <tbody>                               <tr id="section-1">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-1">&#182;</a>               </div>               <p>Core object of the KReportEditor.</p>             </td>             <td class="code">               <div class="highlight"><pre><span class="nb">window</span><span class="p">.</span><span class="nv">KReportEditor = </span><span class="k">class</span> <span class="nx">KReportEditor</span> <span class="k">extends</span> <span class="nx">Cafeine</span><span class="p">.</span><span class="nx">ActiveObject</span></pre></div>             </td>           </tr>                               <tr id="section-2">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-2">&#182;</a>               </div>               <p>Paper format constants</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@FORMATS =</span>
    <span class="nv">A6: </span><span class="p">[</span><span class="s">&#39;10.5cm&#39;</span><span class="p">,</span> <span class="s">&#39;14.8cm&#39;</span><span class="p">]</span>
    <span class="nv">A5: </span><span class="p">[</span><span class="s">&#39;14.8cm&#39;</span><span class="p">,</span> <span class="s">&#39;21cm&#39;</span><span class="p">]</span>
    <span class="nv">A4: </span><span class="p">[</span><span class="s">&#39;21cm&#39;</span><span class="p">,</span> <span class="s">&#39;29.7cm&#39;</span><span class="p">]</span>
    <span class="nv">A3: </span><span class="p">[</span><span class="s">&#39;29.7cm&#39;</span><span class="p">,</span> <span class="s">&#39;42cm&#39;</span><span class="p">]</span>

  <span class="vi">@KNOWN_FORMATS = </span><span class="p">[</span><span class="s">&#39;A3&#39;</span><span class="p">,</span> <span class="s">&#39;A4&#39;</span><span class="p">,</span> <span class="s">&#39;A5&#39;</span><span class="p">,</span> <span class="s">&#39;A6&#39;</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-3">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-3">&#182;</a>               </div>               <p>Recreate <code>KNOWN FORMATS</code> via <code>FORMATS</code> field.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@UPDATE_KNOWN_FORMATS = </span><span class="o">-&gt;</span>
    <span class="vi">@KNOWN_FORMATS = </span><span class="p">[]</span>
    <span class="nx">@KNOWN_FORMATS</span><span class="p">.</span><span class="nx">push</span> <span class="nx">k</span> <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">in</span> <span class="nx">@FORMATS</span></pre></div>             </td>           </tr>                               <tr id="section-4">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-4">&#182;</a>               </div>               <p>Menu hierarchy</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="vi">@MENUS:</span>
    <span class="nv">Report:</span>
      <span class="nv">Save: </span><span class="s">&quot;save&quot;</span>
      <span class="nv">hr1: </span><span class="s">&#39;***&#39;</span>
      <span class="s">&#39;Properties...&#39;</span><span class="o">:</span> <span class="s">&#39;properties&#39;</span>
    <span class="nv">Edit:</span>
      <span class="nv">Undo: </span><span class="s">&#39;undo&#39;</span>
      <span class="nv">Redo: </span><span class="s">&#39;redo&#39;</span>

  <span class="vi">@CONTEXTUAL_MENU: </span><span class="p">{}</span></pre></div>             </td>           </tr>                               <tr id="section-5">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-5">&#182;</a>               </div>               <p>Using of useful <a href="http://github.com/anykeyh/cafeine">cafeine</a> class macros</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@include</span> <span class="nx">Cafeine</span><span class="p">.</span><span class="nx">Plugin</span><span class="p">,</span> <span class="nx">Cafeine</span><span class="p">.</span><span class="nx">Editable</span><span class="p">,</span> <span class="nx">Cafeine</span><span class="p">.</span><span class="nx">Observable</span></pre></div>             </td>           </tr>                               <tr id="section-6">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-6">&#182;</a>               </div>               <p>Here to deploy this class as jquery report.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@jquery_plugin</span> <span class="s">&quot;kreport&quot;</span></pre></div>             </td>           </tr>                               <tr id="section-7">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-7">&#182;</a>               </div>               <p>This class is observable through save action.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@observable</span> <span class="s">&#39;save&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-8">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-8">&#182;</a>               </div>               <p>And we set default value into fields</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">margin_top: </span><span class="s">&#39;1cm&#39;</span>
  <span class="nv">margin_bottom: </span><span class="s">&#39;1cm&#39;</span>
  <span class="nv">margin_left: </span><span class="s">&#39;1cm&#39;</span>
  <span class="nv">margin_right: </span><span class="s">&#39;1cm&#39;</span>
  <span class="nv">name: </span><span class="s">&#39;untitled report&#39;</span>
  <span class="nv">_format: </span><span class="s">&#39;A4&#39;</span>
  <span class="nv">width: </span><span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">FORMATS</span><span class="p">[</span><span class="s">&#39;A4&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
  <span class="nv">height: </span><span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">FORMATS</span><span class="p">[</span><span class="s">&#39;A4&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
  <span class="nv">landscape: </span><span class="kc">no</span></pre></div>             </td>           </tr>                               <tr id="section-9">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-9">&#182;</a>               </div>               <p>Some helper functions
we set a local scope var
for fast use them.</p>             </td>             <td class="code">               <div class="highlight"><pre></pre></div>             </td>           </tr>                               <tr id="section-10">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-10">&#182;</a>               </div>               <p>Here we convert cm to px with resolution of 96 dpi (1 in = 2.54 cm)
For 1/72: 28.346456692913385826771653543305</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">cm2px = </span><span class="vi">@cm2px = </span><span class="nf">(cm) -&gt;</span>
    <span class="nb">parseFloat</span><span class="p">(</span><span class="nx">cm</span><span class="p">)</span> <span class="o">*</span> <span class="mf">37.795275590551181102362204724409</span>

  <span class="nv">px2cm = </span><span class="vi">@px2cm = </span><span class="nf">(px) -&gt;</span>
    <span class="p">(</span><span class="nb">parseFloat</span><span class="p">(</span><span class="nx">px</span><span class="p">)</span> <span class="o">/</span> <span class="mf">37.795275590551181102362204724409</span><span class="p">).</span><span class="nx">round</span><span class="p">(</span><span class="mf">0.01</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;cm&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-11">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-11">&#182;</a>               </div>               <p>Format attribute replace width &amp; height with current format.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@attr</span> <span class="s">&#39;format&#39;</span><span class="p">,</span>
    <span class="nv">get: </span><span class="o">-&gt;</span> <span class="k">return</span> <span class="nx">@_format</span>
    <span class="nv">set: </span><span class="nf">(value) -&gt;</span>
      <span class="nv">vals = </span><span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">FORMATS</span><span class="p">[</span><span class="nx">value</span><span class="p">]</span>
      <span class="k">if</span> <span class="nx">vals</span><span class="o">?</span>
        <span class="vi">@_format = </span><span class="nx">value</span>
      <span class="k">else</span>
        <span class="vi">@_format = </span><span class="s">&#39;A4&#39;</span>
        <span class="nv">vals = </span><span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">FORMATS</span><span class="p">[</span><span class="nx">@_format</span><span class="p">]</span>

      <span class="vi">@width = </span><span class="nx">vals</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="vi">@height = </span><span class="nx">vals</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-12">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-12">&#182;</a>               </div>               <p>Set the parameters as editables.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nx">@editable</span>
    <span class="s">&#39;name&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Name&#39;</span>
      <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
    <span class="s">&#39;format&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Format&#39;</span>
      <span class="nv">type: </span><span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">KNOWN_FORMATS</span>
    <span class="s">&#39;landscape&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Landscape&#39;</span>
      <span class="nv">type: </span><span class="s">&#39;boolean&#39;</span>
    <span class="s">&#39;margin_top&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Margin Top (cm)&#39;</span>
      <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
    <span class="s">&#39;margin_bottom&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Margin Bottom (cm)&#39;</span>
      <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
    <span class="s">&#39;margin_left&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Margin Left some azfazfazfazf text (cm)&#39;</span>
      <span class="nv">type: </span><span class="s">&#39;string&#39;</span>
    <span class="s">&#39;margin_right&#39;</span><span class="o">:</span>
      <span class="nv">label: </span><span class="s">&#39;Margin Right (cm)&#39;</span>
      <span class="nv">type: </span><span class="s">&#39;string&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-13">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-13">&#182;</a>               </div>               <p>Action callbacks.
We check if the action exists in the class.
Else we put a warning.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">when_action: </span><span class="nf">(name) -&gt;</span>
    <span class="k">if</span> <span class="nx">@</span><span class="p">[</span><span class="s">&quot;_when_action_</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]</span><span class="o">?</span>
      <span class="nx">@</span><span class="p">[</span><span class="s">&quot;_when_action_</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span><span class="p">]()</span>
      <span class="k">return</span> <span class="kc">true</span>
    <span class="k">else</span>
      <span class="nx">console</span><span class="p">.</span><span class="nx">log</span> <span class="s">&quot;UNIMPLEMENTED ACTION: </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot;</span>
      <span class="k">return</span> <span class="kc">false</span></pre></div>             </td>           </tr>                               <tr id="section-14">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-14">&#182;</a>               </div>               <p>Here we implement actions methods.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">_when_action_save: </span><span class="o">-&gt;</span>
    <span class="nv">self = </span><span class="k">this</span>
    <span class="nx">@properties</span><span class="p">.</span><span class="nx">propertiesPanel</span> <span class="o">-&gt;</span> <span class="nx">@set</span> <span class="nx">self</span>
    <span class="k">return</span> <span class="kc">true</span>

  <span class="nv">_when_action_properties: </span> <span class="o">-&gt;</span>
    <span class="nv">form = </span><span class="nx">@create_edit_form</span>
      <span class="k">class</span><span class="o">:</span> <span class="s">&#39;form-horizontal&#39;</span></pre></div>             </td>           </tr>                               <tr id="section-15">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-15">&#182;</a>               </div>               <p>It's important to decorate the edit form controllers, to keep homogeneic style.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nv">decoration: </span><span class="nf">(label, control) -&gt;</span>
        <span class="nx">$</span><span class="p">(</span><span class="nx">label</span><span class="p">).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;control-label&#39;</span><span class="p">)</span>
        <span class="nv">control_wrapper = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;controls&#39;</span><span class="p">)</span>
        <span class="nx">control_wrapper</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">control</span><span class="p">)</span>
        <span class="nv">group_wrapper = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;control-group&#39;</span><span class="p">)</span>
        <span class="nx">group_wrapper</span><span class="p">.</span><span class="nx">append</span><span class="p">([</span><span class="nx">label</span><span class="p">,</span> <span class="nx">control_wrapper</span><span class="p">])</span>

        <span class="k">return</span> <span class="nx">group_wrapper</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="nx">@show_dialog</span> <span class="s">&quot;Document properties&quot;</span><span class="p">,</span>
      <span class="nv">content: </span><span class="nx">form</span>
      <span class="nv">buttons:</span>
        <span class="s">&quot;Apply&quot;</span><span class="o">:</span>
          <span class="k">class</span><span class="o">:</span> <span class="s">&quot;btn-primary&quot;</span>
          <span class="nv">click: </span><span class="o">=&gt;</span>
            <span class="nx">form</span><span class="p">.</span><span class="nx">apply_to_object</span><span class="p">()</span>
            <span class="nx">@hide_dialog</span><span class="p">()</span>
        <span class="s">&quot;Cancel&quot;</span><span class="o">:</span>
          <span class="nv">click: </span><span class="o">=&gt;</span>
            <span class="nx">@hide_dialog</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-16">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-16">&#182;</a>               </div>               <p>This will generate the menu bar according to the hierarchy into MENUS constant.
Sample architecture:</p>

<pre><code> &lt;div class="navbar"&gt;
  &lt;div class="navbar-inner"&gt;
    &lt;a class="brand" href="#"&gt;KReport&lt;/a&gt;
    &lt;ul class="nav"&gt;
      &lt;li class="dropdown"&gt;
        &lt;a class="dropdown-toggle" data-toggle="dropdown" href="#"&gt;File&lt;b class="caret"&gt;&lt;/b&gt;&lt;/a&gt;
        &lt;ul class="dropdown-menu" role="menu" aria-labelledby="dLabel"&gt;
          &lt;li&gt;&lt;a tabindex="-1" href="#"&gt;Load&lt;/a&gt;&lt;/li&gt;
          &lt;li&gt;&lt;a tabindex="-1" href="#"&gt;Save&lt;/a&gt;&lt;/li&gt;
        &lt;/ul&gt;
      &lt;/li&gt;
    &lt;/ul&gt;
  &lt;/div&gt;
 &lt;/div&gt;
</code></pre>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">generate_menu_bar: </span><span class="o">-&gt;</span>
    <span class="vi">@navbar = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;navbar kreport-navbar&#39;</span><span class="p">)</span>

    <span class="nv">navbar_inner = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;navbar-inner&#39;</span><span class="p">)</span>

    <span class="nx">@navbar</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">navbar_inner</span><span class="p">)</span>

    <span class="nv">brand = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">({</span> <span class="k">class</span><span class="o">:</span> <span class="s">&#39;brand&#39;</span><span class="p">,</span> <span class="nv">href: </span><span class="s">&#39;#&#39;</span> <span class="p">}).</span><span class="nx">text</span><span class="p">(</span><span class="s">&#39;KReport&#39;</span><span class="p">)</span>
    <span class="nv">nav = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;ul&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;nav&#39;</span><span class="p">)</span>

    <span class="nx">$</span><span class="p">(</span><span class="nx">navbar_inner</span><span class="p">).</span><span class="nx">append</span><span class="p">([</span><span class="nx">brand</span><span class="p">,</span> <span class="nx">nav</span><span class="p">])</span>

    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">MENUS</span>
      <span class="nv">dd = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;dropdown&#39;</span><span class="p">)</span>
      <span class="nx">nav</span><span class="p">.</span><span class="nx">append</span> <span class="nx">dd</span>
      <span class="nx">dd</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;dropdown-toggle&#39;</span><span class="p">,</span> <span class="s">&#39;data-toggle&#39;</span><span class="o">:</span> <span class="s">&#39;dropdown&#39;</span><span class="p">,</span> <span class="s">&#39;href&#39;</span><span class="o">:</span> <span class="s">&#39;#&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="nx">k</span> <span class="o">+</span> <span class="s">&#39;&lt;b class=&quot;caret&quot;&gt;&lt;/b&gt;&#39;</span><span class="p">)</span>
      <span class="nv">dd_ul = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;ul&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;dropdown-menu&#39;</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="s">&#39;menu&#39;</span><span class="p">,</span> <span class="s">&#39;aria-labelledby&#39;</span><span class="o">:</span> <span class="s">&#39;dLabel&#39;</span><span class="p">)</span>
      <span class="nx">dd</span><span class="p">.</span><span class="nx">append</span> <span class="nx">dd_ul</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
        <span class="k">for</span> <span class="nx">k2</span><span class="p">,</span><span class="nx">v2</span> <span class="k">of</span> <span class="nx">v</span>
          <span class="nx">do</span><span class="p">(</span><span class="nx">k</span><span class="o">=</span><span class="nx">k</span><span class="p">,</span> <span class="nx">v</span><span class="o">=</span><span class="nx">v</span><span class="p">,</span> <span class="nx">k2</span><span class="o">=</span><span class="nx">k2</span><span class="p">,</span> <span class="nx">v2</span><span class="o">=</span><span class="nx">v2</span><span class="p">)</span> <span class="o">=&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-17">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-17">&#182;</a>               </div>               <p>Special case when we want a divider.</p>             </td>             <td class="code">               <div class="highlight"><pre>            <span class="k">if</span> <span class="nx">v2</span> <span class="o">is</span> <span class="s">&#39;***&#39;</span>
              <span class="nv">dd_li = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;divider&#39;</span><span class="p">)</span>
              <span class="nx">dd_ul</span><span class="p">.</span><span class="nx">append</span> <span class="nx">dd_li</span>
            <span class="k">else</span></pre></div>             </td>           </tr>                               <tr id="section-18">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-18">&#182;</a>               </div>               <p>We put a <code>do =&gt; =&gt;</code> because we need to output a function which return a function, to keep v2 as internal to function
 FYI it can be translated <code>do =&gt; return =&gt; ...</code> which is better to read?.</p>             </td>             <td class="code">               <div class="highlight"><pre>              <span class="nv">dd_li = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;li&#39;</span><span class="p">))</span>
              <span class="p">.</span><span class="nx">append</span><span class="p">(</span>
                <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">tabindex: </span><span class="s">&#39;-1&#39;</span><span class="p">,</span> <span class="nv">href: </span><span class="s">&#39;#&#39;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span> <span class="nx">do</span> <span class="o">=&gt;</span> <span class="o">=&gt;</span> <span class="nx">@when_action</span><span class="p">(</span><span class="nx">v2</span><span class="p">)</span>  <span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">k2</span><span class="p">)</span>
              <span class="p">)</span>
              <span class="nx">dd_ul</span><span class="p">.</span><span class="nx">append</span> <span class="nx">dd_li</span>

    <span class="k">return</span> <span class="nx">@navbar</span>

  <span class="nv">resize: </span><span class="o">-&gt;</span>
    <span class="nx">@content</span><span class="p">.</span><span class="nx">css</span> <span class="nv">height: </span><span class="nx">@content</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span> <span class="o">-</span>  <span class="nx">@navbar</span><span class="p">.</span><span class="nx">height</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-19">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-19">&#182;</a>               </div>               <p>Dialog handling.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">init_dialog: </span><span class="o">-&gt;</span>
    <span class="vi">@dialog_title = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;h3&#39;</span><span class="p">))</span>
    <span class="vi">@dialog_header = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;modal-header&#39;</span><span class="p">).</span><span class="nx">append</span><span class="p">([</span>
      <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;button&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">type: </span><span class="s">&#39;button&#39;</span><span class="p">,</span> <span class="k">class</span><span class="o">:</span> <span class="s">&#39;close&#39;</span><span class="p">,</span> <span class="s">&#39;data-dismiss&#39;</span><span class="o">:</span><span class="s">&#39;modal&#39;</span><span class="p">,</span> <span class="s">&#39;aria-hidden&#39;</span><span class="o">:</span><span class="s">&#39;true&#39;</span><span class="p">).</span><span class="nx">html</span><span class="p">(</span><span class="s">&quot;&amp;times;&quot;</span><span class="p">)</span>
      <span class="nx">@dialog_title</span>
    <span class="p">])</span>

    <span class="vi">@dialog_content = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;modal-body&#39;</span><span class="p">)</span>
    <span class="vi">@dialog_footer = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;modal-footer&#39;</span><span class="p">)</span>

    <span class="vi">@dialog = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&#39;modal fade&#39;</span><span class="p">).</span><span class="nx">css</span><span class="p">(</span><span class="nv">display: </span><span class="s">&#39;none&#39;</span><span class="p">)</span>
    <span class="nx">@dialog</span><span class="p">.</span><span class="nx">append</span> <span class="p">[</span><span class="nx">@dialog_header</span><span class="p">,</span> <span class="nx">@dialog_content</span><span class="p">,</span> <span class="nx">@dialog_footer</span><span class="p">]</span>
    <span class="k">return</span> <span class="nx">@dialog</span></pre></div>             </td>           </tr>                               <tr id="section-20">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-20">&#182;</a>               </div>               <p>Dialog rendering</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">show_dialog: </span><span class="nf">(title, opts={}) -&gt;</span>
    <span class="nx">@dialog_title</span><span class="p">.</span><span class="nx">text</span><span class="p">(</span><span class="nx">title</span><span class="p">)</span>
    <span class="nx">@dialog</span><span class="p">.</span><span class="nx">css</span><span class="p">(</span><span class="nv">display: </span><span class="s">&#39;block&#39;</span><span class="p">).</span><span class="nx">modal</span><span class="p">()</span>

    <span class="nv">opts = </span><span class="nx">Cafeine</span><span class="p">.</span><span class="nx">merge</span> <span class="p">{</span>
      <span class="nv">content: </span><span class="s">&#39;&#39;</span>
      <span class="nv">buttons: </span><span class="p">{}</span>
    <span class="p">},</span> <span class="nx">opts</span>

    <span class="nx">@dialog_content</span><span class="p">.</span><span class="nx">empty</span><span class="p">().</span><span class="nx">append</span><span class="p">(</span><span class="nx">opts</span><span class="p">.</span><span class="nx">content</span><span class="p">)</span>

    <span class="nx">@dialog_footer</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span>

    <span class="k">for</span> <span class="nx">name</span><span class="p">,</span><span class="nx">parameters</span> <span class="k">of</span> <span class="nx">opts</span><span class="p">.</span><span class="nx">buttons</span>
      <span class="nv">button = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;a&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&quot;btn </span><span class="si">#{</span><span class="nx">parameters</span><span class="p">.</span><span class="k">class</span> <span class="o">?</span> <span class="s">&#39;&#39;</span><span class="si">}</span><span class="s">&quot;</span><span class="p">).</span><span class="nx">click</span><span class="p">(</span> <span class="nx">parameters</span><span class="p">.</span><span class="nx">click</span> <span class="o">?</span> <span class="o">-&gt;</span> <span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>
      <span class="nx">@dialog_footer</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">button</span><span class="p">)</span>

  <span class="nv">hide_dialog: </span><span class="o">-&gt;</span>
    <span class="nx">@dialog</span><span class="p">.</span><span class="nx">modal</span><span class="p">(</span><span class="s">&#39;hide&#39;</span><span class="p">)</span>

  <span class="nv">add_component: </span><span class="nf">(clazz) -&gt;</span>
    <span class="nv">component = </span><span class="nx">Cafeine</span><span class="p">.</span><span class="nx">invoke</span><span class="p">(</span><span class="nx">clazz</span><span class="p">,</span> <span class="p">[</span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)),</span> <span class="k">this</span><span class="p">])</span>
    <span class="nx">@page_content</span><span class="p">.</span><span class="nx">append</span> <span class="nx">component</span><span class="p">.</span><span class="nx">element</span></pre></div>             </td>           </tr>                               <tr id="section-21">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-21">&#182;</a>               </div>               <p>Triggering click to simulate the selection of the new component.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">component</span><span class="p">.</span><span class="nx">element</span><span class="p">.</span><span class="nx">trigger</span><span class="p">(</span><span class="s">&#39;click&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-22">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-22">&#182;</a>               </div>               <p>Refresh the size parameters of the page.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">refresh_page: </span><span class="o">-&gt;</span>
    <span class="nv">inner_width = </span><span class="nx">px2cm</span><span class="p">(</span><span class="nx">cm2px</span><span class="p">(</span><span class="nx">@width</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">cm2px</span><span class="p">(</span><span class="nx">@margin_left</span><span class="p">)</span><span class="o">+</span><span class="nx">cm2px</span><span class="p">(</span><span class="nx">@margin_right</span><span class="p">)))</span>
    <span class="nv">inner_height = </span><span class="nx">px2cm</span><span class="p">(</span><span class="nx">cm2px</span><span class="p">(</span><span class="nx">@height</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="nx">cm2px</span><span class="p">(</span><span class="nx">@margin_top</span><span class="p">)</span><span class="o">+</span><span class="nx">cm2px</span><span class="p">(</span><span class="nx">@margin_bottom</span><span class="p">)))</span>

    <span class="nv">width = </span><span class="nx">@width</span>
    <span class="nv">height = </span><span class="nx">@height</span></pre></div>             </td>           </tr>                               <tr id="section-23">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-23">&#182;</a>               </div>               <p>We swap width and height if it's landscape</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="k">if</span> <span class="nx">@landscape</span>
      <span class="p">[</span><span class="nx">inner_width</span><span class="p">,</span> <span class="nx">inner_height</span><span class="p">,</span> <span class="nx">width</span><span class="p">,</span> <span class="nx">height</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="nx">inner_height</span><span class="p">,</span> <span class="nx">inner_width</span><span class="p">,</span> <span class="nx">height</span><span class="p">,</span> <span class="nx">width</span><span class="p">]</span>

    <span class="vi">@page = </span><span class="nx">$</span><span class="p">(</span><span class="s">&quot;</span><span class="err">#</span><span class="s">kreport-page&quot;</span><span class="p">).</span><span class="nx">css</span>
      <span class="nv">width: </span><span class="nx">width</span>
      <span class="nv">height: </span><span class="nx">height</span>

    <span class="nx">@page_content</span><span class="p">.</span><span class="nx">css</span>
      <span class="s">&#39;margin-left&#39;</span><span class="o">:</span>   <span class="nx">@margin_left</span>
      <span class="s">&#39;margin-right&#39;</span><span class="o">:</span>  <span class="nx">@margin_right</span>
      <span class="s">&#39;margin-top&#39;</span><span class="o">:</span>    <span class="nx">@margin_top</span>
      <span class="s">&#39;margin-bottom&#39;</span><span class="o">:</span> <span class="nx">@margin_bottom</span>
      <span class="nv">width: </span><span class="nx">inner_width</span><span class="p">,</span>
      <span class="nv">height: </span><span class="nx">inner_height</span></pre></div>             </td>           </tr>                               <tr id="section-24">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-24">&#182;</a>               </div>               <p>This generate a bootstrap compliant dropdown menu, with items writtend into a javascript object.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">generate_sub_menu: </span><span class="nf">(obj) -&gt;</span>
    <span class="nv">ul = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;ul&quot;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="k">class</span><span class="o">:</span> <span class="s">&quot;dropdown-menu&quot;</span><span class="p">,</span> <span class="nx">role</span><span class="o">:</span><span class="s">&quot;menu&quot;</span><span class="p">,</span> <span class="s">&quot;aria-labelledby&quot;</span><span class="o">:</span> <span class="s">&quot;dLabel&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="nx">k</span><span class="p">,</span><span class="nx">v</span> <span class="k">of</span> <span class="nx">obj</span>
      <span class="nv">li = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;li&quot;</span><span class="p">))</span>
      <span class="k">if</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">is</span> <span class="s">&#39;undefined&#39;</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;divider&#39;</span><span class="p">)</span>
      <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="k">in</span> <span class="p">[</span><span class="s">&#39;function&#39;</span><span class="p">,</span> <span class="s">&#39;string&#39;</span><span class="p">]</span>
        <span class="nv">in_link = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">tabindex</span><span class="o">:</span><span class="s">&#39;-1&#39;</span><span class="p">,</span> <span class="nx">href</span><span class="o">:</span><span class="s">&#39;#&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nx">do</span><span class="nf">(k=k, v=v, in_link=in_link, self=this) -&gt;</span>
          <span class="nx">in_link</span><span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="o">-&gt;</span>
            <span class="k">if</span> <span class="k">typeof</span> <span class="nx">v</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
              <span class="nx">v</span><span class="p">.</span><span class="nx">call</span><span class="p">(</span><span class="nx">self</span><span class="p">)</span>
            <span class="k">else</span>
              <span class="nx">self</span><span class="p">.</span><span class="nx">when_action</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">append</span> <span class="nx">in_link</span>
      <span class="k">else</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&#39;dropdown-submenu&#39;</span><span class="p">)</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">append</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&quot;a&quot;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nx">tabindex</span><span class="o">:</span><span class="s">&#39;-1&#39;</span><span class="p">,</span> <span class="nx">href</span><span class="o">:</span><span class="s">&#39;#&#39;</span><span class="p">).</span><span class="nx">text</span><span class="p">(</span><span class="nx">k</span><span class="p">)</span>
        <span class="nx">li</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@generate_sub_menu</span><span class="p">(</span><span class="nx">v</span><span class="p">)</span>

      <span class="nx">ul</span><span class="p">.</span><span class="nx">append</span> <span class="nx">li</span>

    <span class="k">return</span> <span class="nx">ul</span>

  <span class="nv">generate_contextual_menu: </span><span class="nf">(target=KReportEditor.CONTEXTUAL_MENU) -&gt;</span>
    <span class="nx">@contextual_menu</span> <span class="o">?=</span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span> <span class="nv">id: </span><span class="s">&quot;kreport-document-context-menu&quot;</span>
    <span class="nx">@contextual_menu</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span>

    <span class="nv">ul = </span><span class="nx">@generate_sub_menu</span><span class="p">(</span><span class="nx">target</span><span class="p">)</span>

    <span class="nx">@contextual_menu</span><span class="p">.</span><span class="nx">append</span> <span class="nx">ul</span></pre></div>             </td>           </tr>                               <tr id="section-25">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-25">&#182;</a>               </div>               <p>Select an HTML element.</p>             </td>             <td class="code">               <div class="highlight"><pre>  <span class="nv">select: </span><span class="nf">(selectable) -&gt;</span>
    <span class="nx">$</span><span class="p">(</span><span class="s">&quot;.selected&quot;</span><span class="p">,</span> <span class="nx">@element</span><span class="p">).</span><span class="nx">removeClass</span><span class="p">(</span><span class="s">&quot;selected&quot;</span><span class="p">)</span>
    <span class="nx">$</span><span class="p">(</span><span class="nx">selectable</span><span class="p">).</span><span class="nx">addClass</span><span class="p">(</span><span class="s">&quot;selected&quot;</span><span class="p">)</span>

  <span class="nv">constructor: </span><span class="nf">(element) -&gt;</span></pre></div>             </td>           </tr>                               <tr id="section-26">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-26">&#182;</a>               </div>               <p>We build the main element structure</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@element = </span><span class="nx">$</span> <span class="nx">element</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">empty</span><span class="p">()</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">@generate_menu_bar</span><span class="p">())</span>

    <span class="vi">@content = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">id: </span><span class="s">&#39;kreport-content&#39;</span><span class="p">)</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">@content</span><span class="p">)</span>

    <span class="vi">@canvas = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">id: </span><span class="s">&#39;kreport-canvas&#39;</span><span class="p">)</span>
    <span class="vi">@toolbox = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">id: </span><span class="s">&#39;kreport-toolbox&#39;</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-27">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-27">&#182;</a>               </div>               <p>Create mighty properties panel! Easy isn't?
see (property panel doc)[view/properties_panel.html]</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="vi">@properties = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">id: </span><span class="s">&#39;kreport-properties-panel&#39;</span><span class="p">)</span>
    <span class="nx">@properties</span><span class="p">.</span><span class="nx">propertiesPanel</span><span class="p">()</span>

    <span class="nx">@toolbox</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="nx">@properties</span><span class="p">)</span>

    <span class="nx">@content</span><span class="p">.</span><span class="nx">append</span> <span class="p">[</span><span class="nx">@toolbox</span><span class="p">,</span> <span class="nx">@canvas</span><span class="p">]</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@content</span>

    <span class="vi">@page = </span><span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">id: </span><span class="s">&#39;kreport-page&#39;</span><span class="p">,</span> <span class="s">&#39;data-target&#39;</span><span class="o">:</span><span class="s">&quot;</span><span class="err">#</span><span class="s">kreport-document-context-menu&quot;</span> <span class="p">)</span>
    <span class="vi">@page_content = </span> <span class="nx">$</span><span class="p">(</span><span class="nb">document</span><span class="p">.</span><span class="nx">createElement</span><span class="p">(</span><span class="s">&#39;div&#39;</span><span class="p">)).</span><span class="nx">attr</span><span class="p">(</span><span class="nv">id: </span><span class="s">&#39;kreport-page-content&#39;</span><span class="p">)</span>
    <span class="nx">@element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@init_dialog</span><span class="p">()</span>

    <span class="nx">@page</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@page_content</span>
    <span class="nx">@canvas</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@page</span>

    <span class="nx">@element</span><span class="p">.</span><span class="nx">append</span> <span class="nx">@generate_contextual_menu</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-28">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-28">&#182;</a>               </div>               <p>contextual menu preparation</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nv">self = </span><span class="k">this</span>
    <span class="nx">@page</span><span class="p">.</span><span class="nx">contextmenu</span><span class="p">()</span>
    <span class="nx">@page</span><span class="p">.</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;contextmenu&#39;</span><span class="p">,</span> <span class="nx">KReportEditor</span><span class="p">.</span><span class="nx">CONTEXTUAL_MENU</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-29">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-29">&#182;</a>               </div>               <p>We check for subcontextual menu</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@page</span>
    <span class="p">.</span><span class="kc">on</span> <span class="s">&#39;context&#39;</span><span class="p">,</span> <span class="nf">(evt) -&gt;</span>
      <span class="nv">item_path = </span><span class="p">[</span><span class="nx">evt</span><span class="p">.</span><span class="nx">mouseTarget</span><span class="p">]</span></pre></div>             </td>           </tr>                               <tr id="section-30">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-30">&#182;</a>               </div>               <p>We select the best context menu for this target.</p>             </td>             <td class="code">               <div class="highlight"><pre>      <span class="nx">$</span><span class="p">(</span><span class="nx">evt</span><span class="p">.</span><span class="nx">mouseTarget</span><span class="p">).</span><span class="nx">parents</span><span class="p">().</span><span class="nx">each</span> <span class="o">-&gt;</span> <span class="nx">item_path</span><span class="p">.</span><span class="nx">push</span> <span class="k">this</span>
      <span class="k">for</span> <span class="nx">x</span> <span class="k">in</span> <span class="nx">item_path</span>
        <span class="nv">menu = </span><span class="nx">$</span><span class="p">(</span><span class="nx">x</span><span class="p">).</span><span class="nx">data</span><span class="p">(</span><span class="s">&#39;contextmenu&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="k">typeof</span> <span class="nx">menu</span> <span class="o">is</span> <span class="s">&#39;object&#39;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">generate_contextual_menu</span><span class="p">(</span><span class="nx">menu</span><span class="p">)</span>
          <span class="k">break</span>
        <span class="k">else</span> <span class="k">if</span> <span class="k">typeof</span> <span class="nx">menu</span> <span class="o">is</span> <span class="s">&#39;function&#39;</span>
          <span class="nx">self</span><span class="p">.</span><span class="nx">generate_contextual_menu</span><span class="p">(</span><span class="nx">menu</span><span class="p">())</span>
          <span class="k">break</span></pre></div>             </td>           </tr>                               <tr id="section-31">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-31">&#182;</a>               </div>               <p>When we click on page, we select the page properties</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="p">.</span><span class="kc">on</span> <span class="s">&#39;click&#39;</span><span class="p">,</span> <span class="nf">(evt) -&gt;</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">select</span> <span class="nx">self</span><span class="p">.</span><span class="nx">page</span>
      <span class="nx">self</span><span class="p">.</span><span class="nx">properties</span><span class="p">.</span><span class="nx">propertiesPanel</span><span class="p">(</span><span class="s">&#39;set&#39;</span><span class="p">,</span> <span class="nx">self</span><span class="p">)</span></pre></div>             </td>           </tr>                               <tr id="section-32">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-32">&#182;</a>               </div>               <p>We prepare the bootstrap dropdown plugins</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;.dropdown-toggle&#39;</span><span class="p">).</span><span class="nx">dropdown</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-33">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-33">&#182;</a>               </div>               <p>Call resize once to keep each elements up...</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@resize</span><span class="p">()</span></pre></div>             </td>           </tr>                               <tr id="section-34">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-34">&#182;</a>               </div>               <p>... And call it every time when window resize.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="nb">window</span><span class="p">).</span><span class="nx">resize</span> <span class="o">=&gt;</span> <span class="nx">@resize</span></pre></div>             </td>           </tr>                               <tr id="section-35">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-35">&#182;</a>               </div>               <p>Helper to keep tracking of mouseposition into the soft</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">$</span><span class="p">(</span><span class="s">&#39;body&#39;</span><span class="p">).</span><span class="kc">on</span> <span class="s">&#39;mousemove&#39;</span><span class="p">,</span> <span class="p">(</span><span class="nx">evt</span><span class="p">)</span> <span class="o">=&gt;</span>
      <span class="vi">@mouseX = </span><span class="nx">evt</span><span class="p">.</span><span class="nx">pageX</span>
      <span class="vi">@mouseY = </span><span class="nx">evt</span><span class="p">.</span><span class="nx">pageY</span></pre></div>             </td>           </tr>                               <tr id="section-36">             <td class="docs">               <div class="pilwrap">                 <a class="pilcrow" href="#section-36">&#182;</a>               </div>               <p>We refresh also the page properties size every time we update the editables fields.</p>             </td>             <td class="code">               <div class="highlight"><pre>    <span class="nx">@when_edition_done</span> <span class="nx">@refresh_page</span>

</pre></div>             </td>           </tr>                </tbody>     </table>   </div> </body> </html> 